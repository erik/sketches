<!doctype html>

<head>
    <title>Where is Erik?</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.3/dist/leaflet.css"
      integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
      crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.3/dist/leaflet.js"
      integrity="sha512-tAGcCfR4Sc5ZP5ZoVz0quoZDYX5aCtEm/eu1KhSLj2c9eFrylXZknQYmxUssFaVJKvvc0dJQixhGjG2yXWiV9Q=="
      crossorigin=""></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
</head>

<div id="map"></div>

<script type="text/javascript">
 const map = L.map('map').setView([34, -118], 10);

 L.tileLayer(
   'https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}{r}.png', {
     attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
     subdomains: 'abcd',
     minZoom: 0,
     maxZoom: 20
   }).addTo(map);

 fetch('/where')
   .then(data => data.json())
   .then(json => json.where)
   .then(points => {
     if (points.length === 0) return;

     const polyline = L.polyline(points.map(it => [it.lat, it.lng])).addTo(map);
     // TODO: bug in mobile safari when bounds are close together
     map.fitBounds(polyline.getBounds(), {maxZoom: 10});

     points.forEach(point => {
       const ts = moment(point.ts);

       L.marker([point.lat, point.lng])
        .bindPopup(`<p>${point.comment}</p>` +
                   `<em title="${ts}">${ts.fromNow()}</em>`)
        .addTo(map);
     });
   })
   .catch(err => { alert(`Failed to get coordinates: ${err}`); });
</script>

<style>
 html, body, #map { height: 100%; width: 100vw; }
 body { padding: 0; margin: 0; }
</style>
