<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Vector Map Demo</title>
        <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mapbox-gl/1.13.0/mapbox-gl.js"></script>
        <link href="//cdnjs.cloudflare.com/ajax/libs/mapbox-gl/1.13.0/mapbox-gl.css" rel="stylesheet" />
        <style type="text/css">
         body {
             margin: 0;
             padding: 0;
         }

         #map {
             position: absolute;
             top: 0;
             bottom: 0;
             width: 100%;
         }
        </style>
    </head>
    <body>
        <div id="map"></div>
        <script type="text/javascript">
         let points = [];
         var map = new mapboxgl.Map({
             container: 'map',
             style: 'https://tiles.stadiamaps.com/styles/outdoors.json',
             center: [12, 53],
             zoom: 4
         });

         map.on('load', () => {
             map.addSource('points', {
                 type: 'geojson',
                 data: {
                     type: 'Feature',
                     properties: {},
                     geometry: {
                         type: 'LineString',
                         coordinates: []
                     }
                 }
             });
             map.addLayer({
                 id: 'route',
                 type: 'line',
                 source: 'points',
                 layout: {'line-join': 'round', 'line-cap': 'round'},
                 paint: {'line-color': '#888', 'line-width': 8}
             });
         });

         function drawLine(points) {
             const data = {
                 type: 'Feature',
                 properties: {},
                 geometry: {
                     type: 'LineString',
                     coordinates: points.map(({lat, lon}) => [lon, lat])
                 }
             };
             console.log('Setting data to ', data);
             map.getSource('points').setData(data);
         }

         // Mapbox GL JS has a bug in it's handling of RTL, so we have to grab this dependency as well until they
         // combine it with the main library
         mapboxgl.setRTLTextPlugin('https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-rtl-text/v0.2.1/mapbox-gl-rtl-text.js');

         // Add zoom and rotation controls to the map.
         map.addControl(new mapboxgl.NavigationControl());

         map.on('click', (e) => {
             let {lat, lng} = e.lngLat;
             points.push({lat, lon: lng});
             if (points.length === 2) {
                 let [from, to] = points;
                 points = [];
                 fetch('/route', {
                     headers: { 'Content-Type': 'application/json' },
                     method: 'POST',
                     body: JSON.stringify({from, to}),
                 })
                     .then(res => res.json())
                     .then(res => {
                         console.log('res: ', res);
                         if (res.route) {
                             drawLine(res.route);
                         }
                     })
                     .catch(err => console.error(err));
             }
         });
        </script>
    </body>
</html>
